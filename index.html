<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WFRP ‚Äì Gestionnaire de combat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="MJ.css" />
</head>
<body>
  <header class="topbar">
    <div class="wrap">
      <h1>‚öîÔ∏è WFRP ‚Äì Gestionnaire</h1>
      <div class="spacer"></div>
      <nav class="tabs" role="tablist" aria-label="Sections">
        <button class="tab is-active" data-tab="reserve" aria-selected="true">R√©serve</button>
        <button class="tab" data-tab="combat" aria-selected="false">Combat</button>
        <button class="tab" data-tab="rules" aria-selected="false">R√®gles</button>
      </nav>
      <button id="btn-version" class="ghost small" style="margin-left:10px; opacity:0.6;">v?</button>
    </div>
  </header>

  <main class="wrap">
    <section id="panel-reserve" class="panel is-active" role="region" aria-labelledby="tab-reserve">
      <h2>R√©serve (source de v√©rit√©)</h2>
      <div class="grid-2">
        <form id="form-add" class="card">
          <input type="hidden" name="id" value="">
          <h3 id="form-title">Nouveau profil</h3>
          <div class="grid-2">
            <label>Nom<input name="name" placeholder="Saskia la Noire" required></label>
            <label>Type<select name="kind"><option value="PJ">PJ</option><option value="Cr√©ature">Cr√©ature</option></select></label>
            <label>Initiative (I) <small class="muted">Score de caract√©ristique</small><input type="number" name="initiative" value="30"></label>
            <label>PV (Max)<input type="number" name="hp" value="12"></label>
          </div>
          <div class="armor-section" style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 6px;">
            <span class="muted" style="font-size: 0.9em; font-weight: bold;">Points d'Armure</span>
            <div class="grid-4" style="margin-top: 6px;">
              <label>T√™te<input type="number" name="armor_head" value="0"></label>
              <label>Corps<input type="number" name="armor_body" value="0"></label>
              <label>Bras<input type="number" name="armor_arms" value="0"></label>
              <label>Jambes<input type="number" name="armor_legs" value="0"></label>
            </div>
          </div>
          <details>
            <summary>Caracs (optionnel)</summary>
            <div class="grid-3">
              <label>CC<input type="number" name="CC"></label>
              <label>CT<input type="number" name="CT"></label>
              <label>F<input type="number" name="F"></label>
              <label>E<input type="number" name="E"></label>
              <label>I<input type="number" name="I"></label>
              <label>Ag<input type="number" name="Ag"></label>
              <label>Dex<input type="number" name="Dex"></label>
              <label>Int<input type="number" name="Int"></label>
              <label>FM<input type="number" name="FM"></label>
              <label>Soc<input type="number" name="Soc"></label>
            </div>
          </details>
          <div class="actions">
            <button type="submit" id="btn-submit-form">Ajouter</button>
            <button type="button" id="btn-cancel-edit" class="ghost" style="display:none;">Annuler</button>
            <div class="spacer"></div>
            <button type="button" id="seed-reserve" class="ghost small">Exemple</button>
            <button type="button" id="clear-reserve" class="danger ghost small">Vider</button>
          </div>
        </form>
        <div class="card">
          <div class="row">
            <h3>Liste</h3>
            <div class="spacer"></div>
            <input id="search-reserve" placeholder="Filtrer‚Ä¶" />
          </div>
          <div id="reserve-list" class="list"></div>
        </div>
      </div>
    </section>

    <section id="panel-combat" class="panel" role="region" aria-labelledby="tab-combat">
      
      <div class="controls row card">
        <div class="row">
            <button id="btn-save-file" style="border-color:#3e2e22;">üíæ Sauvegarder</button>
            <button id="btn-load-file" class="ghost">üìÇ Charger</button>
            <input type="file" id="file-input" accept=".json" style="display:none;" />
        </div>
        <div class="spacer"></div>
        <div class="row">
            <button id="btn-import" class="ghost">Imp. R√©serve</button>
            <button id="btn-export" class="ghost">Exp. R√©serve</button>
        </div>
        <div class="spacer"></div>
        <div class="row">
          <button id="btn-start">D√©marrer</button>
          <button id="btn-d100">Lancer d100</button>
          <button id="btn-reset" class="ghost" style="border-color:#b36e3a; color:#b36e3a;">Nettoyer Piste</button>
        </div>
      </div>

      <div class="row meta card">
        <span class="pill" id="pill-round">Round: 0</span>
        <span class="pill" id="pill-turn">Tour: ‚Äì</span>
        <div class="spacer"></div>
        <span class="muted">Glissez-d√©posez les cartes pour organiser l'ordre</span>
      </div>

      <div id="dice-prep-results" class="dice-result-stream card" style="min-height: 60px; margin-bottom: 16px;"></div>

      <div id="init-tracker" class="init-tracker card row"></div>

      <div class="zone-container active-container">
        <h3>üî• Zone Active (Au c≈ìur de l'action)</h3>
        <div id="zone-active" class="drop-zone" data-zone="active">
            <div class="placeholder">Glissez les combattants actifs ici...</div>
        </div>
      </div>

      <div class="zone-container bench-container">
        <h3>üí§ En attente / R√©serve tactique</h3>
        <div id="zone-bench" class="drop-zone" data-zone="bench"></div>
      </div>

      <details class="card" style="margin-top: 16px;">
        <summary class="row" style="cursor:pointer; font-weight:bold; color:#5a1d1d; padding:4px 0;">
          üìú Journal (Cliquer pour afficher/masquer)
        </summary>
        <div class="row" style="margin-top:10px; border-bottom:1px solid #ccc; padding-bottom:8px;">
            <div class="spacer"></div>
            <button id="btn-clear-log" class="ghost">Effacer l'historique</button>
        </div>
        <div id="log" class="log"></div>
      </details>

    </section>

    <section id="panel-rules" class="panel" role="region" aria-labelledby="tab-rules">
        <h2>Aides de Jeu & R√®gles</h2>
        
        <div class="card rule-block">
            <details>
                <summary>Localisation des d√©g√¢ts & Tables Critiques</summary>
                <div class="rule-content">
                    <p>D'apr√®s le <em>Livre de base de Warhammer Fantasy le Jeu de R√¥le (4e √©dition)</em> :</p>
                    
                    <h4>1. La R√®gle de base : Inverser les d√©s</h4>
                    <p>Pour d√©terminer o√π un coup atterrit apr√®s un Test de Corps √† corps ou de Projectiles r√©ussi, vous devez simplement <strong>inverser le r√©sultat des d√©s</strong> de votre jet d'attaque.</p>
                    <p class="example"><em>Exemple :</em> Si vous r√©ussissez votre attaque avec un jet de <strong>23</strong>, vous inversez les chiffres pour obtenir <strong>32</strong>. Si vous obtenez <strong>04</strong>, la localisation est <strong>40</strong>. Si vous obtenez <strong>10</strong> (le 10 comptant pour 0 sur le d√© des unit√©s), l'inverse est <strong>01</strong>.</p>

                    <h4>2. Le Tableau de Localisation</h4>
                    <table class="wfrp-table">
                        <thead><tr><th>Jet</th><th>Localisation</th></tr></thead>
                        <tbody>
                            <tr><td>01 ‚Äì 09</td><td>T√™te</td></tr>
                            <tr><td>10 ‚Äì 24</td><td>Bras gauche (ou bras secondaire)</td></tr>
                            <tr><td>25 ‚Äì 44</td><td>Bras droit (ou bras principal)</td></tr>
                            <tr><td>45 ‚Äì 79</td><td>Corps</td></tr>
                            <tr><td>80 ‚Äì 89</td><td>Jambe gauche</td></tr>
                            <tr><td>90 ‚Äì 00</td><td>Jambe droite</td></tr>
                        </tbody>
                    </table>

                    <h4>3. Exception pour les Coups Critiques</h4>
                    <p>Si votre jet d'attaque est un <strong>Coup Critique</strong> (un succ√®s sur un double, par exemple 11, 22, 33...), la proc√©dure change. Vous n'inversez pas le jet d'attaque. √Ä la place :</p>
                    <ul>
                        <li>Vous lancez un <strong>nouveau 1d100</strong> pour d√©terminer la localisation (en consultant le tableau ci-dessus).</li>
                        <li>Vous lancez un <strong>second 1d100</strong> pour d√©terminer la gravit√© de la blessure sur le Tableau des Critiques correspondant √† cette localisation (voir ci-dessous).</li>
                    </ul>

                    <h3 style="margin-top:30px; border-top:2px solid #5a1d1d; padding-top:10px;">Tableaux des Coups Critiques</h3>
                    <p class="muted">G√©n√©r√©s automatiquement par le syst√®me :</p>
                    
                    <details class="nested-details">
                        <summary>üíÄ Critiques √† la T√™te</summary>
                        <div id="table-head-crit"></div>
                    </details>
                    
                    <details class="nested-details">
                        <summary>üí™ Critiques au Bras</summary>
                        <div id="table-arm-crit"></div>
                    </details>
                    
                    <details class="nested-details">
                        <summary>üëï Critiques au Corps</summary>
                        <div id="table-body-crit"></div>
                    </details>
                    
                    <details class="nested-details">
                        <summary>ü¶µ Critiques √† la Jambe</summary>
                        <div id="table-leg-crit"></div>
                    </details>
                </div>
            </details>
        </div>

        <div class="card rule-block">
            <details>
                <summary>Sant√©, Critiques et Survie</summary>
                <div class="rule-content">
                    <h4>1. Les Blessures et l'√âtat de Sant√©</h4>
                    <p>Vos Points de Blessures (B) repr√©sentent votre capacit√© √† encaisser la douleur et la fatigue.</p>
                    <ul>
                        <li><strong>Subir des D√©g√¢ts :</strong> D√©g√¢ts de l'arme + DR ‚Äì (Bonus d'Endurance + Points d'Armure) = Blessures perdues.</li>
                        <li><strong>Tomber √† 0 Blessures :</strong>
                            <ul>
                                <li>Vous gagnez imm√©diatement l'√âtat <strong>√Ä Terre</strong>.</li>
                                <li>Si vous n'√™tes pas soign√© (au moins 1 B) en un nombre de Rounds √©gal √† votre <strong>Bonus d'Endurance</strong>, vous gagnez l'√âtat <strong>Inconscient</strong>.</li>
                            </ul>
                        </li>
                        <li><strong>Le Sympt√¥me ¬´ Bless√© ¬ª :</strong> Attention, ce terme d√©signe un sympt√¥me sp√©cifique de maladie (plaie infect√©e). Il emp√™che la r√©cup√©ration de Points de Blessures tant qu'il n'est pas trait√©.</li>
                    </ul>

                    <h4>2. Les Coups Critiques</h4>
                    <p>Une Blessure Critique est une atteinte grave (os bris√©, h√©morragie, amputation) qui applique des malus et peut tuer.</p>
                    <p><strong>Quand subit-on un Critique ?</strong></p>
                    <ol>
                        <li><strong>Le Double :</strong> L'attaquant r√©ussit son Test avec un double (ex: 22, 44).<br><em>Note : La victime subit le Critique ET les d√©g√¢ts normaux.</em></li>
                        <li><strong>L'Acharnement (0 PV) :</strong> Si la cible est r√©duite √† 0 Blessures (ou l'est d√©j√†), tout coup port√© inflige automatiquement un Critique.</li>
                    </ol>
                    <p><strong>R√©solution d'un Critique :</strong></p>
                    <ul>
                        <li><strong>Localisation :</strong> Ne pas inverser les d√©s. Lancer 1d100 sur le tableau de localisation pour savoir o√π le coup porte.</li>
                        <li><strong>Gravit√© :</strong> Lancer 1d100 sur le tableau des Blessures Critiques de la localisation concern√©e.</li>
                        <li><strong>R√®gle du +10 :</strong> Si la cible est √† 0 Blessures, ajoutez +10 au jet de gravit√© pour chaque point de d√©g√¢t qui a d√©pass√© 0 (ou pour chaque point inflig√© si elle √©tait d√©j√† √† 0).</li>
                    </ul>

                    <h4>3. La Mort</h4>
                    <p>La mort d'un Personnage survient dans deux cas pr√©cis :</p>
                    <ol>
                        <li><strong>R√©sultat Mortel :</strong> Le jet sur le tableau des Critiques indique ¬´ Mort ¬ª (g√©n√©ralement sur un r√©sultat de 90-100+).</li>
                        <li><strong>Accumulation de Critiques :</strong> Si un Personnage est Inconscient avec 0 Blessures et que le nombre total de Blessures Critiques actives (non soign√©es) d√©passe son <strong>Bonus d'Endurance</strong>, il meurt √† la fin du Round.<br><em>Note : Les blessures critiques not√©es ¬´ T ¬ª (Triviales/Mineures) ne comptent pas dans ce total.</em></li>
                    </ol>

                    <h4>4. Comment √âviter ou Att√©nuer un Critique</h4>
                    <p>M√™me si le jet d'attaque indique un critique, le d√©fenseur a plusieurs options pour sauver sa peau.</p>
                    
                    <strong>A. L'√âquipement et l'Armure</strong>
                    <ul>
                        <li><strong>D√©viation Critique (Sacrifice d'Armure) :</strong> Si la localisation touch√©e est prot√©g√©e par une armure, vous pouvez choisir de sacrifier 1 Point d'Armure (l'endommageant jusqu'√† r√©paration) pour ignorer la Blessure Critique. Vous subissez tout de m√™me les d√©g√¢ts normaux.</li>
                        <li><strong>Qualit√© Imp√©n√©trable :</strong> (Armures de plaques) Permet d'ignorer les Critiques caus√©s par des jets d'attaque impairs (ex: 11, 33, 55).</li>
                        <li><strong>Armure de Gromril :</strong> (Nains) Immunise aux Critiques (deviennent des coups normaux), sauf si d√©g√¢ts inflig√©s alors que d√©j√† √† 0 Blessures.</li>
                    </ul>

                    <strong>B. Les Points de Destin et de R√©silience</strong>
                    <ul>
                        <li><strong>Point de Destin (Meurs un autre jour) :</strong> Vous √©vitez la mort in extremis. Vous √™tes hors de combat, mais survivez. Vos Blessures ne descendent pas sous 0.</li>
                        <li><strong>Point de R√©silience (Je ne faillirai pas !) :</strong> Vous pouvez choisir le r√©sultat d'un d√©. Par exemple, d√©cider que l'attaque ennemie est un √©chec, ou choisir un jet de localisation sur votre armure la plus solide.</li>
                    </ul>

                    <strong>C. Talents et Magie</strong>
                    <ul>
                        <li><strong>Esquive / Parade :</strong> Gagner le test oppos√© annule l'attaque, donc le critique.</li>
                        <li><strong>Trait Protection (Ward) :</strong> (Cr√©atures/Objets magiques) Lancez 1d10 ; si >= indice, le coup et le critique sont ignor√©s.</li>
                        <li><strong>B√©n√©diction de Vigueur :</strong> Augmente l'Endurance (aide contre l'accumulation de critiques).</li>
                        <li><strong>Chirurgie :</strong> N√©cessaire pour soigner les critiques les plus graves.</li>
                    </ul>
                </div>
            </details>
        </div>
    </section>

  </main>

  <template id="tpl-actor">
    <div class="actor-card" draggable="true">
      <div class="actor-header row">
        <div class="actor-info">
            <strong class="name">Nom</strong>
            <div class="sub-info">
                <span class="badge clickable init-badge">Init 0</span>
                <span class="badge hp-badge">PV 0</span>
                <span class="badge adv-badge">AV 0</span>
            </div>
            <div class="states" style="margin-top:4px; display:flex; gap:4px; flex-wrap:wrap;"></div>
        </div>
        <div class="actor-actions">
            <button class="icon-btn btn-color" title="Couleur">üé®</button>
            <button class="icon-btn btn-state" title="Bless√©">ü©∏</button>
            <button class="icon-btn danger btn-remove" title="Retirer">‚úï</button>
        </div>
      </div>
      
      <div class="color-palette hidden">
          <div class="color-swatch" style="background:var(--card-bg-default);" data-c="default" title="D√©faut"></div>
          <div class="color-swatch" style="background:var(--card-bg-red);" data-c="red" title="Ennemi"></div>
          <div class="color-swatch" style="background:var(--card-bg-green);" data-c="green" title="Alli√©"></div>
          <div class="color-swatch" style="background:var(--card-bg-blue);" data-c="blue" title="Magie"></div>
          <div class="color-swatch" style="background:var(--card-bg-purple);" data-c="purple" title="Chaos"></div>
          <div class="color-swatch" style="background:var(--card-bg-orange);" data-c="orange" title="Boss"></div>
      </div>

      <div class="actor-controls row">
        <button class="tiny btn-hp-minus">‚àíPV</button>
        <button class="tiny btn-hp-plus">+PV</button>
        <div class="spacer"></div>
        <button class="tiny btn-adv-minus">‚àíAV</button>
        <button class="tiny btn-adv-plus">+AV</button>
      </div>

      <div class="actor-armor muted"></div>

      <div class="actor-dice-section">
        <div class="dice-list"></div>
        <button class="btn-add-dice full-width ghost small">+ Ajouter un jet</button>
      </div>
    </div>
  </template>

  <dialog id="dlg-import">
    <form method="dialog" class="card">
      <h3>Importer depuis la R√©serve</h3>
      <div id="import-list" class="list"></div>
      <div class="row actions">
        <div class="spacer"></div>
        <button value="cancel" class="ghost">Annuler</button>
        <button id="confirm-import">Importer</button>
      </div>
    </form>
  </dialog>

  <script src="MJ.js?v=4"></script>
</body>
</html>
